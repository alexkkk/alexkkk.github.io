<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="redis," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="redis&amp;#x7684;&amp;#x54C8;&amp;#x5E0C;&amp;#x8BBE;&amp;#x8BA1;&amp;#x662F;redis&amp;#x9AD8;&amp;#x6548;&amp;#x7684;&amp;#x539F;&amp;#x56E0;&amp;#x4E4B;&amp;#x4E00;&amp;#xFF0C;&amp;#x6240;&amp;#x4EE5;&amp;#x9700;&amp;#x8981;&amp;#x4ED4;&amp;#x7EC6;&amp;#x5B66;&amp;#x4E60;&amp;#x4E0B;&amp;#x300">
<meta property="og:type" content="article">
<meta property="og:title" content="redis-5-dict数据结构分析">
<meta property="og:url" content="http://yoursite.com/2016/06/19/redis-5-dict数据结构分析/index.html">
<meta property="og:site_name" content="INCLUDE">
<meta property="og:description" content="redis&amp;#x7684;&amp;#x54C8;&amp;#x5E0C;&amp;#x8BBE;&amp;#x8BA1;&amp;#x662F;redis&amp;#x9AD8;&amp;#x6548;&amp;#x7684;&amp;#x539F;&amp;#x56E0;&amp;#x4E4B;&amp;#x4E00;&amp;#xFF0C;&amp;#x6240;&amp;#x4EE5;&amp;#x9700;&amp;#x8981;&amp;#x4ED4;&amp;#x7EC6;&amp;#x5B66;&amp;#x4E60;&amp;#x4E0B;&amp;#x300">
<meta property="og:image" content="http://yoursite.com/2016/06/19/redis-5-dict数据结构分析/redis_dict.png">
<meta property="og:updated_time" content="2016-09-28T17:12:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="redis-5-dict数据结构分析">
<meta name="twitter:description" content="redis&amp;#x7684;&amp;#x54C8;&amp;#x5E0C;&amp;#x8BBE;&amp;#x8BA1;&amp;#x662F;redis&amp;#x9AD8;&amp;#x6548;&amp;#x7684;&amp;#x539F;&amp;#x56E0;&amp;#x4E4B;&amp;#x4E00;&amp;#xFF0C;&amp;#x6240;&amp;#x4EE5;&amp;#x9700;&amp;#x8981;&amp;#x4ED4;&amp;#x7EC6;&amp;#x5B66;&amp;#x4E60;&amp;#x4E0B;&amp;#x300">
<meta name="twitter:image" content="http://yoursite.com/2016/06/19/redis-5-dict数据结构分析/redis_dict.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2016/06/19/redis-5-dict数据结构分析/"/>

  <title> redis-5-dict数据结构分析 | INCLUDE </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">INCLUDE</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                redis-5-dict数据结构分析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-06-19T15:38:31+08:00" content="2016-06-19">
              2016-06-19
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>redis&#x7684;&#x54C8;&#x5E0C;&#x8BBE;&#x8BA1;&#x662F;redis&#x9AD8;&#x6548;&#x7684;&#x539F;&#x56E0;&#x4E4B;&#x4E00;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x4ED4;&#x7EC6;&#x5B66;&#x4E60;&#x4E0B;&#x3002;</p>
<h2 id="1-&#x6574;&#x4F53;&#x7ED3;&#x6784;&#x56FE;"><a href="#1-&#x6574;&#x4F53;&#x7ED3;&#x6784;&#x56FE;" class="headerlink" title="1.&#x6574;&#x4F53;&#x7ED3;&#x6784;&#x56FE;"></a>1.&#x6574;&#x4F53;&#x7ED3;&#x6784;&#x56FE;</h2><p>&#x4E0B;&#x9762;&#x7684;&#x56FE;&#x662F;&#x4ECE;&#x7F51;&#x4E0A;&#x627E;&#x7684;&#x89C9;&#x5F97;&#x753B;&#x7684;&#x4E0D;&#x9519;&#x7684;dict&#x7684;&#x6574;&#x4F53;&#x7ED3;&#x6784;&#x56FE;&#xFF0C;&#x8FD9;&#x91CC;&#x662F;<a href="http://dl2.iteye.com/upload/attachment/0065/0089/eb1fa067-b45a-391b-ae3b-6b3c54ec13d3.png" target="_blank" rel="external">&#x94FE;&#x63A5;</a><br><img src="/2016/06/19/redis-5-dict&#x6570;&#x636E;&#x7ED3;&#x6784;&#x5206;&#x6790;/redis_dict.png" alt="redis_dict"></p>
<h2 id="dict"><a href="#dict" class="headerlink" title="dict"></a>dict</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * &#x5B57;&#x5178;</div><div class="line"> *</div><div class="line"> * &#x6BCF;&#x4E2A;&#x5B57;&#x5178;&#x4F7F;&#x7528;&#x4E24;&#x4E2A;&#x54C8;&#x5E0C;&#x8868;&#xFF0C;&#x7528;&#x4E8E;&#x5B9E;&#x73B0;&#x6E10;&#x8FDB;&#x5F0F; rehash</div><div class="line"> */</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dict {</div><div class="line"></div><div class="line">    <span class="comment">// &#x7279;&#x5B9A;&#x4E8E;&#x7C7B;&#x578B;&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;</span></div><div class="line">    dictType *type;</div><div class="line"></div><div class="line">    <span class="comment">// &#x7C7B;&#x578B;&#x5904;&#x7406;&#x51FD;&#x6570;&#x7684;&#x79C1;&#x6709;&#x6570;&#x636E;</span></div><div class="line">    <span class="keyword">void</span> *privdata;</div><div class="line"></div><div class="line">    <span class="comment">// &#x54C8;&#x5E0C;&#x8868;&#xFF08;2&#x4E2A;&#xFF09;</span></div><div class="line">    dictht ht[<span class="number">2</span>];</div><div class="line"></div><div class="line">    <span class="comment">// &#x8BB0;&#x5F55; rehash &#x8FDB;&#x5EA6;&#x7684;&#x6807;&#x5FD7;&#xFF0C;&#x503C;&#x4E3A;-1 &#x8868;&#x793A; rehash &#x672A;&#x8FDB;&#x884C;</span></div><div class="line">    <span class="keyword">int</span> rehashidx;</div><div class="line"></div><div class="line">    <span class="comment">// &#x5F53;&#x524D;&#x6B63;&#x5728;&#x8FD0;&#x4F5C;&#x7684;&#x5B89;&#x5168;&#x8FED;&#x4EE3;&#x5668;&#x6570;&#x91CF;</span></div><div class="line">    <span class="keyword">int</span> iterators;</div><div class="line"></div><div class="line">} dict;</div></pre></td></tr></table></figure>
<p>&#x6574;&#x4E2A;dict&#x7531;2&#x5404;&#x54C8;&#x5E0C;&#x8868;&#x4EE5;&#x53CA;&#x4E00;&#x4E9B;&#x79C1;&#x6709;&#x6570;&#x636E;&#x548C;&#x5904;&#x7406;&#x51FD;&#x6570;&#x7EC4;&#x6210;&#xFF0C;&#x7528;2&#x4E2A;&#x54C8;&#x5E0C;&#x8868;&#x662F;&#x4E3A;&#x4E86;&#x5B9E;&#x73B0;&#x539F;&#x5B50;&#x6027;&#x7684;&#x53CC;buffer&#x5207;&#x6362;.</p>
<h2 id="dictType"><a href="#dictType" class="headerlink" title="dictType"></a>dictType</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * &#x7279;&#x5B9A;&#x4E8E;&#x7C7B;&#x578B;&#x7684;&#x4E00;&#x7C07;&#x5904;&#x7406;&#x51FD;&#x6570;</div><div class="line"> */</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dictType {</div><div class="line">    <span class="comment">// &#x8BA1;&#x7B97;&#x952E;&#x7684;&#x54C8;&#x5E0C;&#x503C;&#x51FD;&#x6570;, &#x8BA1;&#x7B97;key&#x5728;hash table&#x4E2D;&#x7684;&#x5B58;&#x50A8;&#x4F4D;&#x7F6E;&#xFF0C;&#x4E0D;&#x540C;&#x7684;dict&#x53EF;&#x4EE5;&#x6709;&#x4E0D;&#x540C;&#x7684;hash function.</span></div><div class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*hashFunction)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *key)</span></span>;</div><div class="line">    <span class="comment">// &#x590D;&#x5236;&#x952E;&#x7684;&#x51FD;&#x6570;</span></div><div class="line">    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key);</div><div class="line">    <span class="comment">// &#x590D;&#x5236;&#x503C;&#x7684;&#x51FD;&#x6570;</span></div><div class="line">    <span class="keyword">void</span> *(*valDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *obj);</div><div class="line">    <span class="comment">// &#x5BF9;&#x6BD4;&#x4E24;&#x4E2A;&#x952E;&#x7684;&#x51FD;&#x6570;</span></div><div class="line">    <span class="keyword">int</span> (*keyCompare)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key1, <span class="keyword">const</span> <span class="keyword">void</span> *key2);</div><div class="line">    <span class="comment">// &#x952E;&#x7684;&#x91CA;&#x6784;&#x51FD;&#x6570;</span></div><div class="line">    <span class="keyword">void</span> (*keyDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *key);</div><div class="line">    <span class="comment">// &#x503C;&#x7684;&#x91CA;&#x6784;&#x51FD;&#x6570;</span></div><div class="line">    <span class="keyword">void</span> (*valDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *obj);</div><div class="line">} dictType;</div></pre></td></tr></table></figure>
<p>dictType&#x6709;&#x5982;&#x4E0B;&#x7684;&#x51E0;&#x79CD;&#xFF1A;</p>
<ol>
<li>setDictType</li>
<li>zsetDictType</li>
<li>dbDictType</li>
<li>shaScriptObjectDictType</li>
<li>keyptrDictType</li>
<li>commandTableDictType</li>
<li>hashDictType</li>
<li>keylistDictType</li>
<li>clusterNodesDictType</li>
<li>migrateCacheDictType</li>
</ol>
<p>&#x4E0A;&#x8FF0;&#x7684;&#x4E0D;&#x540C;dictType&#x6709;&#x4E0D;&#x540C;&#x7684;hash&#x51FD;&#x6570;&#xFF0C;&#x952E;&#x590D;&#x5236;&#x6BD4;&#x8F83;&#x91CA;&#x653E;&#x51FD;&#x6570;&#xFF0C;&#x503C;&#x590D;&#x5236;&#x91CA;&#x653E;&#x51FD;&#x6570;</p>
<h3 id="setDictType"><a href="#setDictType" class="headerlink" title="setDictType"></a>setDictType</h3><p>&#x6211;&#x4EEC;&#x4E3B;&#x8981;&#x5173;&#x6CE8;&#x4E0B;hash&#x51FD;&#x6570;&#xFF0C;&#x590D;&#x5236;&#x6BD4;&#x8F83;&#x91CA;&#x653E;&#x51FD;&#x6570;&#x5C31;&#x662F;&#x7EDF;&#x4E00;&#x7684;robj&#x7684;&#x590D;&#x5236;&#x6BD4;&#x8F83;&#x91CA;&#x653E;&#xFF0C;&#x5728;&#x5206;&#x6790;robj&#x7684;&#x65F6;&#x5019;&#x5177;&#x4F53;&#x5206;&#x6790;&#x3002;<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">dictType setDictType = {</div><div class="line">    dictEncObjHash,            <span class="comment">/* hash function */</span></div><div class="line">    <span class="literal">NULL</span>,                      <span class="comment">/* key dup */</span></div><div class="line">    <span class="literal">NULL</span>,                      <span class="comment">/* val dup */</span></div><div class="line">    dictEncObjKeyCompare,      <span class="comment">/* key compare */</span></div><div class="line">    dictRedisObjectDestructor, <span class="comment">/* key destructor */</span></div><div class="line">    <span class="literal">NULL</span>                       <span class="comment">/* val destructor */</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">///@alex:&#x54C8;&#x5E0C;&#x51FD;&#x6570;</span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">dictEncObjHash</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *key)</span> </span>{</div><div class="line">    robj *o = (robj*) key;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (o-&gt;encoding == REDIS_ENCODING_RAW) {</div><div class="line">        <span class="keyword">return</span> dictGenHashFunction(o-&gt;ptr, sdslen((sds)o-&gt;ptr));</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        <span class="keyword">if</span> (o-&gt;encoding == REDIS_ENCODING_INT) {</div><div class="line">            <span class="keyword">char</span> buf[<span class="number">32</span>];</div><div class="line">            <span class="keyword">int</span> len;</div><div class="line"></div><div class="line">            len = ll2string(buf,<span class="number">32</span>,(<span class="keyword">long</span>)o-&gt;ptr);</div><div class="line">            <span class="keyword">return</span> dictGenHashFunction((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)buf, len);</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> hash;</div><div class="line"></div><div class="line">            o = getDecodedObject(o);</div><div class="line">            hash = dictGenHashFunction(o-&gt;ptr, sdslen((sds)o-&gt;ptr));</div><div class="line">            decrRefCount(o);</div><div class="line">            <span class="keyword">return</span> hash;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Generic hash function (a popular one from Bernstein).</span></div><div class="line"> * I tested a few and this was the best. */</div><div class="line"><span class="comment">///@alex: &#x5BF9;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x8FDB;&#x884C;hash&#x7684;&#x65B9;&#x6CD5;</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">dictGenHashFunction</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> len)</span> </span>{</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> hash = <span class="number">5381</span>;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (len--)</div><div class="line">        hash = ((hash &lt;&lt; <span class="number">5</span>) + hash) + (*buf++); <span class="comment">/* hash * 33 + c */</span></div><div class="line">    <span class="keyword">return</span> hash;</div><div class="line">}</div></pre></td></tr></table></figure></p>
<h3 id="zsetDictType"><a href="#zsetDictType" class="headerlink" title="zsetDictType"></a>zsetDictType</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Sorted sets hash (note: a skiplist is used in addition to the hash table) */</span></div><div class="line">dictType zsetDictType = {</div><div class="line">    dictEncObjHash,            <span class="comment">/* hash function */</span></div><div class="line">    <span class="literal">NULL</span>,                      <span class="comment">/* key dup */</span></div><div class="line">    <span class="literal">NULL</span>,                      <span class="comment">/* val dup */</span></div><div class="line">    dictEncObjKeyCompare,      <span class="comment">/* key compare */</span></div><div class="line">    dictRedisObjectDestructor, <span class="comment">/* key destructor */</span></div><div class="line">    <span class="literal">NULL</span>                       <span class="comment">/* val destructor */</span></div><div class="line">};</div></pre></td></tr></table></figure>
<p>hash&#x51FD;&#x6570;&#x8DDF;&#x4E0A;&#x9762;&#x7684;&#x76F8;&#x540C;</p>
<h3 id="dbDictType"><a href="#dbDictType" class="headerlink" title="dbDictType"></a>dbDictType</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Db-&gt;dict, keys are sds strings, vals are Redis objects. */</span></div><div class="line">dictType dbDictType = {</div><div class="line">    dictSdsHash,                <span class="comment">/* hash function */</span></div><div class="line">    <span class="literal">NULL</span>,                       <span class="comment">/* key dup */</span></div><div class="line">    <span class="literal">NULL</span>,                       <span class="comment">/* val dup */</span></div><div class="line">    dictSdsKeyCompare,          <span class="comment">/* key compare */</span></div><div class="line">    dictSdsDestructor,          <span class="comment">/* key destructor */</span></div><div class="line">    dictRedisObjectDestructor   <span class="comment">/* val destructor */</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">dictSdsHash</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *key)</span> </span>{</div><div class="line">    <span class="keyword">return</span> dictGenHashFunction((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)key, sdslen((<span class="keyword">char</span>*)key));</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x8FD9;&#x4E2A;hash&#x51FD;&#x6570;&#x6700;&#x7EC8;&#x4E5F;&#x662F;&#x8F6C;&#x6362;&#x6210;&#x5B57;&#x8282;&#x6570;&#x636E;&#x7684;hash&#x65B9;&#x6CD5;</p>
<h3 id="shaScriptObjectDictType"><a href="#shaScriptObjectDictType" class="headerlink" title="shaScriptObjectDictType"></a>shaScriptObjectDictType</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* server.lua_scripts sha (as sds string) -&gt; scripts (as robj) cache. */</span></div><div class="line">dictType shaScriptObjectDictType = {</div><div class="line">    dictSdsCaseHash,            <span class="comment">/* hash function */</span></div><div class="line">    <span class="literal">NULL</span>,                       <span class="comment">/* key dup */</span></div><div class="line">    <span class="literal">NULL</span>,                       <span class="comment">/* val dup */</span></div><div class="line">    dictSdsKeyCaseCompare,      <span class="comment">/* key compare */</span></div><div class="line">    dictSdsDestructor,          <span class="comment">/* key destructor */</span></div><div class="line">    dictRedisObjectDestructor   <span class="comment">/* val destructor */</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">dictSdsCaseHash</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *key)</span> </span>{</div><div class="line">    <span class="keyword">return</span> dictGenCaseHashFunction((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)key, sdslen((<span class="keyword">char</span>*)key));</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* And a case insensitive version */</span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">dictGenCaseHashFunction</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> len)</span> </span>{</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> hash = dict_hash_function_seed;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (len--)</div><div class="line">        hash = ((hash &lt;&lt; <span class="number">5</span>) + hash) + (<span class="built_in">tolower</span>(*buf++)); <span class="comment">/* hash * 33 + c */</span></div><div class="line">    <span class="keyword">return</span> hash;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x8FD9;&#x4E2A;&#x662F;&#x5927;&#x5C0F;&#x5199;&#x4E0D;&#x654F;&#x611F;&#x7684;&#xFF0C;&#x5148;&#x5C06;&#x5927;&#x5199;&#x8F6C;&#x6362;&#x6210;&#x5C0F;&#x5199;&#xFF0C;&#x7136;&#x540E;&#x540C;&#x6837;&#x8FDB;&#x884C;&#x5B57;&#x8282;&#x6570;&#x7EC4;hash</p>
<h3 id="keyptrDictType"><a href="#keyptrDictType" class="headerlink" title="keyptrDictType"></a>keyptrDictType</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Db-&gt;expires */</span></div><div class="line">dictType keyptrDictType = {</div><div class="line">    dictSdsHash,               <span class="comment">/* hash function */</span></div><div class="line">    <span class="literal">NULL</span>,                      <span class="comment">/* key dup */</span></div><div class="line">    <span class="literal">NULL</span>,                      <span class="comment">/* val dup */</span></div><div class="line">    dictSdsKeyCompare,         <span class="comment">/* key compare */</span></div><div class="line">    <span class="literal">NULL</span>,                      <span class="comment">/* key destructor */</span></div><div class="line">    <span class="literal">NULL</span>                       <span class="comment">/* val destructor */</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">dictSdsHash</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *key)</span> </span>{</div><div class="line">    <span class="keyword">return</span> dictGenHashFunction((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)key, sdslen((<span class="keyword">char</span>*)key));</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8FD9;&#x4E2A;hash&#x51FD;&#x6570;&#x6700;&#x7EC8;&#x4E5F;&#x662F;&#x8F6C;&#x6362;&#x6210;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x8FDB;&#x884C;hash</p>
<h3 id="commandTableDictType"><a href="#commandTableDictType" class="headerlink" title="commandTableDictType"></a>commandTableDictType</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Command table. sds string -&gt; command struct pointer. */</span></div><div class="line">dictType commandTableDictType = {</div><div class="line">    dictSdsCaseHash,           <span class="comment">/* hash function */</span></div><div class="line">    <span class="literal">NULL</span>,                      <span class="comment">/* key dup */</span></div><div class="line">    <span class="literal">NULL</span>,                      <span class="comment">/* val dup */</span></div><div class="line">    dictSdsKeyCaseCompare,     <span class="comment">/* key compare */</span></div><div class="line">    dictSdsDestructor,         <span class="comment">/* key destructor */</span></div><div class="line">    <span class="literal">NULL</span>                       <span class="comment">/* val destructor */</span></div><div class="line">};</div></pre></td></tr></table></figure>
<p>&#x8FD9;&#x4E2A;&#x8DDF;shaScriptObjectDictType&#x7684;hash&#x51FD;&#x6570;&#x4E00;&#x6837;</p>
<h3 id="hashDictType"><a href="#hashDictType" class="headerlink" title="hashDictType"></a>hashDictType</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Hash type hash table (note that small hashes are represented with zimpaps) */</span></div><div class="line">dictType hashDictType = {</div><div class="line">    dictEncObjHash,             <span class="comment">/* hash function */</span></div><div class="line">    <span class="literal">NULL</span>,                       <span class="comment">/* key dup */</span></div><div class="line">    <span class="literal">NULL</span>,                       <span class="comment">/* val dup */</span></div><div class="line">    dictEncObjKeyCompare,       <span class="comment">/* key compare */</span></div><div class="line">    dictRedisObjectDestructor,  <span class="comment">/* key destructor */</span></div><div class="line">    dictRedisObjectDestructor   <span class="comment">/* val destructor */</span></div><div class="line">};</div></pre></td></tr></table></figure>
<p>dictEncObjHash&#x4E0A;&#x9762;&#x5DF2;&#x7ECF;&#x4ECB;&#x7ECD;&#x8FC7;&#x4E86;</p>
<h3 id="keylistDictType"><a href="#keylistDictType" class="headerlink" title="keylistDictType"></a>keylistDictType</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Keylist hash table type has unencoded redis objects as keys and</span></div><div class="line"> * lists as values. It&apos;s used for blocking operations (BLPOP) and to</div><div class="line"> * map swapped keys to a list of clients waiting for this keys to be loaded. */</div><div class="line">dictType keylistDictType = {</div><div class="line">    dictObjHash,                <span class="comment">/* hash function */</span></div><div class="line">    <span class="literal">NULL</span>,                       <span class="comment">/* key dup */</span></div><div class="line">    <span class="literal">NULL</span>,                       <span class="comment">/* val dup */</span></div><div class="line">    dictObjKeyCompare,          <span class="comment">/* key compare */</span></div><div class="line">    dictRedisObjectDestructor,  <span class="comment">/* key destructor */</span></div><div class="line">    dictListDestructor          <span class="comment">/* val destructor */</span></div><div class="line">};</div></pre></td></tr></table></figure>
<p>dictObjHash&#x4E0A;&#x9762;&#x5DF2;&#x7ECF;&#x4ECB;&#x7ECD;&#x8FC7;&#x4E86;</p>
<h3 id="clusterNodesDictType"><a href="#clusterNodesDictType" class="headerlink" title="clusterNodesDictType"></a>clusterNodesDictType</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Cluster nodes hash table, mapping nodes addresses 1.2.3.4:6379 to</span></div><div class="line"> * clusterNode structures. */</div><div class="line">dictType clusterNodesDictType = {</div><div class="line">    dictSdsHash,                <span class="comment">/* hash function */</span></div><div class="line">    <span class="literal">NULL</span>,                       <span class="comment">/* key dup */</span></div><div class="line">    <span class="literal">NULL</span>,                       <span class="comment">/* val dup */</span></div><div class="line">    dictSdsKeyCompare,          <span class="comment">/* key compare */</span></div><div class="line">    dictSdsDestructor,          <span class="comment">/* key destructor */</span></div><div class="line">    <span class="literal">NULL</span>                        <span class="comment">/* val destructor */</span></div><div class="line">};</div></pre></td></tr></table></figure>
<p>dictSdsHash&#x4E4B;&#x524D;&#x5DF2;&#x7ECF;&#x4ECB;&#x7ECD;&#x8FC7;&#x4E86;</p>
<h3 id="migrateCacheDictType"><a href="#migrateCacheDictType" class="headerlink" title="migrateCacheDictType"></a>migrateCacheDictType</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Migrate cache dict type. */</span></div><div class="line">dictType migrateCacheDictType = {</div><div class="line">    dictSdsHash,                <span class="comment">/* hash function */</span></div><div class="line">    <span class="literal">NULL</span>,                       <span class="comment">/* key dup */</span></div><div class="line">    <span class="literal">NULL</span>,                       <span class="comment">/* val dup */</span></div><div class="line">    dictSdsKeyCompare,          <span class="comment">/* key compare */</span></div><div class="line">    dictSdsDestructor,          <span class="comment">/* key destructor */</span></div><div class="line">    <span class="literal">NULL</span>                        <span class="comment">/* val destructor */</span></div><div class="line">};</div></pre></td></tr></table></figure>
<p>dictSdsHash&#x4E4B;&#x524D;&#x5DF2;&#x7ECF;&#x4ECB;&#x7ECD;&#x8FC7;&#x4E86;</p>
<h2 id="2-dictht"><a href="#2-dictht" class="headerlink" title="2.dictht"></a>2.dictht</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * &#x54C8;&#x5E0C;&#x8868;</div><div class="line"> */</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dictht {</div><div class="line"></div><div class="line">    <span class="comment">// &#x54C8;&#x5E0C;&#x8868;&#x8282;&#x70B9;&#x6307;&#x9488;&#x6570;&#x7EC4;&#xFF08;&#x4FD7;&#x79F0;&#x6876;&#xFF0C;bucket&#xFF09;</span></div><div class="line">    dictEntry **table;</div><div class="line"></div><div class="line">    <span class="comment">// &#x6307;&#x9488;&#x6570;&#x7EC4;&#x7684;&#x5927;&#x5C0F;</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size;</div><div class="line"></div><div class="line">    <span class="comment">// &#x6307;&#x9488;&#x6570;&#x7EC4;&#x7684;&#x957F;&#x5EA6;&#x63A9;&#x7801;&#xFF0C;&#x7528;&#x4E8E;&#x8BA1;&#x7B97;&#x7D22;&#x5F15;&#x503C;</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sizemask;</div><div class="line"></div><div class="line">    <span class="comment">// &#x54C8;&#x5E0C;&#x8868;&#x73B0;&#x6709;&#x7684;&#x8282;&#x70B9;&#x6570;&#x91CF;</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> used;</div><div class="line"></div><div class="line">} dictht;</div><div class="line">&#x8FD9;&#x4E2A;&#x662F;&#x771F;&#x6B63;&#x7684;hash&#x8868;</div></pre></td></tr></table></figure>
<h2 id="3-&#x521B;&#x5EFA;dict"><a href="#3-&#x521B;&#x5EFA;dict" class="headerlink" title="3.&#x521B;&#x5EFA;dict"></a>3.&#x521B;&#x5EFA;dict</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function">dict *<span class="title">dictCreate</span><span class="params">(dictType *type, <span class="keyword">void</span> *privDataPtr)</span></span></div><div class="line">{</div><div class="line">    <span class="comment">// &#x5206;&#x914D;&#x7A7A;&#x95F4;</span></div><div class="line">    dict *d = zmalloc(<span class="keyword">sizeof</span>(*d));</div><div class="line"></div><div class="line">    <span class="comment">// &#x521D;&#x59CB;&#x5316;&#x5B57;&#x5178;</span></div><div class="line">    _dictInit(d,type,privDataPtr);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> d;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">int</span> _dictInit(dict *d, dictType *type,</div><div class="line">        <span class="keyword">void</span> *privDataPtr)</div><div class="line">{</div><div class="line">    <span class="comment">// &#x521D;&#x59CB;&#x5316; ht[0]</span></div><div class="line">    _dictReset(&amp;d-&gt;ht[<span class="number">0</span>]);</div><div class="line"></div><div class="line">    <span class="comment">// &#x521D;&#x59CB;&#x5316; ht[1]</span></div><div class="line">    _dictReset(&amp;d-&gt;ht[<span class="number">1</span>]);</div><div class="line"></div><div class="line">    <span class="comment">// &#x521D;&#x59CB;&#x5316;&#x5B57;&#x5178;&#x5C5E;&#x6027;</span></div><div class="line">    d-&gt;type = type;</div><div class="line">    d-&gt;privdata = privDataPtr;</div><div class="line">    d-&gt;rehashidx = <span class="number">-1</span>;</div><div class="line">    d-&gt;iterators = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> DICT_OK;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> _dictReset(dictht *ht)</div><div class="line">{</div><div class="line">    ht-&gt;table = <span class="literal">NULL</span>;</div><div class="line">    ht-&gt;size = <span class="number">0</span>;</div><div class="line">    ht-&gt;sizemask = <span class="number">0</span>;</div><div class="line">    ht-&gt;used = <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
<h2 id="4-&#x6E05;&#x7A7A;dict"><a href="#4-&#x6E05;&#x7A7A;dict" class="headerlink" title="4.&#x6E05;&#x7A7A;dict"></a>4.&#x6E05;&#x7A7A;dict</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dictEmpty</span><span class="params">(dict *d)</span> </span>{</div><div class="line">    _dictClear(d,&amp;d-&gt;ht[<span class="number">0</span>]);</div><div class="line">    _dictClear(d,&amp;d-&gt;ht[<span class="number">1</span>]);</div><div class="line">    d-&gt;rehashidx = <span class="number">-1</span>;</div><div class="line">    d-&gt;iterators = <span class="number">0</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">int</span> _dictClear(dict *d, dictht *ht)</div><div class="line">{</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> i;</div><div class="line"></div><div class="line">    <span class="comment">/* Free all the elements */</span></div><div class="line">    <span class="comment">// &#x904D;&#x5386;&#x54C8;&#x5E0C;&#x8868;&#x6570;&#x7EC4;</span></div><div class="line">    <span class="comment">///@alex: hash&#x8868;&#x73B0;&#x6709;&#x7684;&#x8282;&#x70B9;&#x6570;&#x91CF;</span></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ht-&gt;size &amp;&amp; ht-&gt;used &gt; <span class="number">0</span>; i++) {</div><div class="line">        dictEntry *he, *nextHe;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ((he = ht-&gt;table[i]) == <span class="literal">NULL</span>) <span class="keyword">continue</span>;</div><div class="line">        <span class="comment">// &#x91CA;&#x653E;&#x6574;&#x4E2A;&#x94FE;&#x8868;&#x4E0A;&#x7684;&#x5143;&#x7D20;</span></div><div class="line">        <span class="comment">// &#x56E0;&#x4E3A;&#x94FE;&#x8868;&#x7684;&#x5143;&#x7D20;&#x6570;&#x91CF;&#x901A;&#x5E38;&#x4E3A; 1 &#xFF0C;&#x6216;&#x8005;&#x7EF4;&#x6301;&#x5728;&#x4E00;&#x4E2A;&#x5F88;&#x5C0F;&#x7684;&#x6BD4;&#x7387;</span></div><div class="line">        <span class="comment">// &#x56E0;&#x6B64;&#x53EF;&#x4EE5;&#x5C06;&#x8FD9;&#x4E2A;&#x64CD;&#x4F5C;&#x770B;&#x4F5C; O(1)</span></div><div class="line">        <span class="keyword">while</span>(he) {</div><div class="line">            nextHe = he-&gt;next;</div><div class="line"></div><div class="line">            dictFreeKey(d, he);</div><div class="line">            dictFreeVal(d, he);</div><div class="line"></div><div class="line">            zfree(he);</div><div class="line"></div><div class="line">            ht-&gt;used--;</div><div class="line"></div><div class="line">            he = nextHe;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Free the table and the allocated cache structure */</span></div><div class="line">    zfree(ht-&gt;table);</div><div class="line"></div><div class="line">    <span class="comment">/* Re-initialize the table */</span></div><div class="line">    _dictReset(ht);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> DICT_OK; <span class="comment">/* never fails */</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">///@alex:&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x7C7B;&#x578B;&#x5BF9;&#x5E94;&#x7684;&#x6790;&#x6784;&#x51FD;&#x6570;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> dictFreeKey(d, entry) \</span></div><div class="line">    <span class="meta-keyword">if</span> ((d)-&gt;type-&gt;keyDestructor) \</div><div class="line">        (d)-&gt;type-&gt;keyDestructor((d)-&gt;privdata, (entry)-&gt;key)</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> dictFreeVal(d, entry) \</span></div><div class="line">    <span class="meta-keyword">if</span> ((d)-&gt;type-&gt;valDestructor) \</div><div class="line">        (d)-&gt;type-&gt;valDestructor((d)-&gt;privdata, (entry)-&gt;v.val)</div></pre></td></tr></table></figure>
<h2 id="&#x6DFB;&#x52A0;key-value"><a href="#&#x6DFB;&#x52A0;key-value" class="headerlink" title="&#x6DFB;&#x52A0;key/value"></a>&#x6DFB;&#x52A0;key/value</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictAdd</span><span class="params">(dict *d, <span class="keyword">void</span> *key, <span class="keyword">void</span> *val)</span></span></div><div class="line">{</div><div class="line">    <span class="comment">// &#x6DFB;&#x52A0; key &#x5230;&#x54C8;&#x5E0C;&#x8868;&#xFF0C;&#x8FD4;&#x56DE;&#x5305;&#x542B;&#x8BE5; key &#x7684;&#x8282;&#x70B9;</span></div><div class="line">    dictEntry *entry = dictAddRaw(d,key);</div><div class="line"></div><div class="line">    <span class="comment">// &#x6DFB;&#x52A0;&#x5931;&#x8D25;&#xFF1F;</span></div><div class="line">    <span class="keyword">if</span> (!entry) <span class="keyword">return</span> DICT_ERR;</div><div class="line"></div><div class="line">    <span class="comment">// &#x8BBE;&#x7F6E;&#x8282;&#x70B9;&#x7684;&#x503C;</span></div><div class="line">    dictSetVal(d, entry, val);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> DICT_OK;</div><div class="line">}</div><div class="line"></div><div class="line">### dictAddRaw</div><div class="line"><span class="comment">/*</span></div><div class="line"> * &#x6DFB;&#x52A0; key &#x5230;&#x5B57;&#x5178;&#x7684;&#x5E95;&#x5C42;&#x5B9E;&#x73B0;&#xFF0C;&#x5B8C;&#x6210;&#x4E4B;&#x540E;&#x8FD4;&#x56DE;&#x65B0;&#x8282;&#x70B9;&#x3002;</div><div class="line"> *</div><div class="line"> * &#x5982;&#x679C; key &#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#xFF0C;&#x8FD4;&#x56DE; NULL &#x3002;</div><div class="line"> *</div><div class="line"> * T = O(1)</div><div class="line"> */</div><div class="line"><span class="function">dictEntry *<span class="title">dictAddRaw</span><span class="params">(dict *d, <span class="keyword">void</span> *key)</span></span></div><div class="line">{</div><div class="line">    <span class="keyword">int</span> index;</div><div class="line">    dictEntry *entry;</div><div class="line">    dictht *ht;</div><div class="line"></div><div class="line">    <span class="comment">// &#x5C1D;&#x8BD5;&#x6E10;&#x8FDB;&#x5F0F;&#x5730; rehash &#x4E00;&#x4E2A;&#x5143;&#x7D20;</span></div><div class="line">    <span class="keyword">if</span> (dictIsRehashing(d)) _dictRehashStep(d);</div><div class="line"></div><div class="line">    <span class="comment">// &#x67E5;&#x627E;&#x53EF;&#x5BB9;&#x7EB3;&#x65B0;&#x5143;&#x7D20;&#x7684;&#x7D22;&#x5F15;&#x4F4D;&#x7F6E;</span></div><div class="line">    <span class="comment">// &#x5982;&#x679C;&#x5143;&#x7D20;&#x5DF2;&#x5B58;&#x5728;&#xFF0C; index &#x4E3A; -1</span></div><div class="line">    <span class="keyword">if</span> ((index = _dictKeyIndex(d, key)) == <span class="number">-1</span>)</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* Allocate the memory and store the new entry */</span></div><div class="line">    <span class="comment">// &#x51B3;&#x5B9A;&#x8BE5;&#x628A;&#x65B0;&#x5143;&#x7D20;&#x653E;&#x5728;&#x90A3;&#x4E2A;&#x54C8;&#x5E0C;&#x8868;</span></div><div class="line">    ht = dictIsRehashing(d) ? &amp;d-&gt;ht[<span class="number">1</span>] : &amp;d-&gt;ht[<span class="number">0</span>];</div><div class="line">    <span class="comment">// &#x4E3A;&#x65B0;&#x5143;&#x7D20;&#x5206;&#x914D;&#x8282;&#x70B9;&#x7A7A;&#x95F4;</span></div><div class="line">    entry = zmalloc(<span class="keyword">sizeof</span>(*entry));</div><div class="line">    <span class="comment">// &#x65B0;&#x8282;&#x70B9;&#x7684;&#x540E;&#x7EE7;&#x6307;&#x9488;&#x6307;&#x5411;&#x65E7;&#x7684;&#x8868;&#x5934;&#x8282;&#x70B9;</span></div><div class="line">    entry-&gt;next = ht-&gt;table[index];</div><div class="line">    <span class="comment">// &#x8BBE;&#x7F6E;&#x65B0;&#x8282;&#x70B9;&#x4E3A;&#x8868;&#x5934;</span></div><div class="line">    ht-&gt;table[index] = entry;</div><div class="line">    <span class="comment">// &#x66F4;&#x65B0;&#x5DF2;&#x6709;&#x8282;&#x70B9;&#x6570;&#x91CF;</span></div><div class="line">    ht-&gt;used++;</div><div class="line"></div><div class="line">    <span class="comment">/* Set the hash entry fields. */</span></div><div class="line">    <span class="comment">// &#x5173;&#x8054;&#x8D77;&#x8282;&#x70B9;&#x548C; key</span></div><div class="line">    dictSetKey(d, entry, key);</div><div class="line"></div><div class="line">    <span class="comment">// &#x8FD4;&#x56DE;&#x65B0;&#x8282;&#x70B9;</span></div><div class="line">    <span class="keyword">return</span> entry;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x6574;&#x4E2A;add&#x8FC7;&#x7A0B;&#x5982;&#x4E0B;</p>
<ol>
<li>&#x5148;&#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;rehash</li>
<li>&#x5224;&#x65AD;key&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;</li>
<li>&#x5982;&#x679C;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#xFF0C;&#x8FD4;&#x56DE;null</li>
<li>&#x5982;&#x679C;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x6839;&#x636E;&#x662F;&#x5426;rehash&#x51B3;&#x5B9A;&#x5728;&#x54EA;&#x4E2A;&#x54C8;&#x5E0C;&#x8868;&#x5206;&#x914D;&#x7A7A;&#x95F4;&#x8FDB;&#x884C;&#x63D2;&#x5165;</li>
</ol>
<p>&#x5177;&#x4F53;rehash&#x64CD;&#x4F5C;&#x5982;&#x4E0B;:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="comment">///@alex: rehash&#x64CD;&#x4F5C;</span></div><div class="line"><span class="comment">/*</span></div><div class="line"> * &#x5982;&#x679C;&#x6761;&#x4EF6;&#x5141;&#x8BB8;&#x7684;&#x8BDD;&#xFF0C;&#x5C06;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x4ECE; ht[0] &#x8FC1;&#x79FB;&#x81F3; ht[1]</div><div class="line"> *</div><div class="line"> * &#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x88AB;&#x5176;&#x4ED6;&#x67E5;&#x627E;&#x548C;&#x66F4;&#x65B0;&#x51FD;&#x6570;&#x6240;&#x8C03;&#x7528;&#xFF0C;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x6E10;&#x8FDB;&#x5F0F; rehash &#x3002;</div><div class="line"> *</div><div class="line"> * T = O(1)</div><div class="line"> */</div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> _dictRehashStep(dict *d) {</div><div class="line">    <span class="comment">// &#x53EA;&#x5728;&#x6CA1;&#x6709;&#x5B89;&#x5168;&#x8FED;&#x4EE3;&#x5668;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x624D;&#x80FD;&#x8FDB;&#x884C;&#x8FC1;&#x79FB;</span></div><div class="line">    <span class="comment">// &#x5426;&#x5219;&#x53EF;&#x80FD;&#x4F1A;&#x4EA7;&#x751F;&#x91CD;&#x590D;&#x5143;&#x7D20;&#xFF0C;&#x6216;&#x8005;&#x4E22;&#x5931;&#x5143;&#x7D20;</span></div><div class="line">    <span class="keyword">if</span> (d-&gt;iterators == <span class="number">0</span>) dictRehash(d,<span class="number">1</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">///@alex: rehash&#x8FC7;&#x7A0B;</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictRehash</span><span class="params">(dict *d, <span class="keyword">int</span> n)</span> </span>{</div><div class="line"><span class="comment">///@alex: d-&gt;rehashindex = 0 &#x662F;&#x5728;dictExpand&#x4E2D;&#x8FDB;&#x884C;&#x8D4B;&#x503C;&#x7684;</span></div><div class="line">    <span class="keyword">if</span> (!dictIsRehashing(d)) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">while</span>(n--) {</div><div class="line">        dictEntry *de, *nextde;</div><div class="line"></div><div class="line">        <span class="comment">// &#x5982;&#x679C; ht[0] &#x5DF2;&#x7ECF;&#x4E3A;&#x7A7A;&#xFF0C;&#x90A3;&#x4E48;&#x8FC1;&#x79FB;&#x5B8C;&#x6BD5;</span></div><div class="line">        <span class="comment">// &#x7528; ht[1] &#x4EE3;&#x66FF;&#x539F;&#x6765;&#x7684; ht[0]</span></div><div class="line">        <span class="keyword">if</span> (d-&gt;ht[<span class="number">0</span>].used == <span class="number">0</span>) {</div><div class="line"></div><div class="line">            <span class="comment">// &#x91CA;&#x653E; ht[0] &#x7684;&#x54C8;&#x5E0C;&#x8868;&#x6570;&#x7EC4;</span></div><div class="line">            zfree(d-&gt;ht[<span class="number">0</span>].table);</div><div class="line"></div><div class="line">            <span class="comment">// &#x5C06; ht[0] &#x6307;&#x5411; ht[1]</span></div><div class="line">            d-&gt;ht[<span class="number">0</span>] = d-&gt;ht[<span class="number">1</span>];</div><div class="line"></div><div class="line">            <span class="comment">// &#x6E05;&#x7A7A; ht[1] &#x7684;&#x6307;&#x9488;</span></div><div class="line">            _dictReset(&amp;d-&gt;ht[<span class="number">1</span>]);</div><div class="line"></div><div class="line">            <span class="comment">// &#x5173;&#x95ED; rehash &#x6807;&#x8BC6;</span></div><div class="line">            d-&gt;rehashidx = <span class="number">-1</span>;</div><div class="line"></div><div class="line">            <span class="comment">// &#x901A;&#x77E5;&#x8C03;&#x7528;&#x8005;&#xFF0C; rehash &#x5B8C;&#x6BD5;</span></div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Note that rehashidx can&apos;t overflow as we are sure there are more</span></div><div class="line">         * elements because ht[0].used != 0 */</div><div class="line">        assert(d-&gt;ht[<span class="number">0</span>].size &gt; (<span class="keyword">unsigned</span>)d-&gt;rehashidx);</div><div class="line">        <span class="comment">// &#x79FB;&#x52A8;&#x5230;&#x6570;&#x7EC4;&#x4E2D;&#x9996;&#x4E2A;&#x4E0D;&#x4E3A; NULL &#x94FE;&#x8868;&#x7684;&#x7D22;&#x5F15;&#x4E0A;</span></div><div class="line">        <span class="keyword">while</span>(d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx] == <span class="literal">NULL</span>) d-&gt;rehashidx++;</div><div class="line">        <span class="comment">// &#x6307;&#x5411;&#x94FE;&#x8868;&#x5934;</span></div><div class="line">        de = d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx];</div><div class="line">        <span class="comment">// &#x5C06;&#x94FE;&#x8868;&#x5185;&#x7684;&#x6240;&#x6709;&#x5143;&#x7D20;&#x4ECE; ht[0] &#x8FC1;&#x79FB;&#x5230; ht[1]</span></div><div class="line">        <span class="comment">// &#x56E0;&#x4E3A;&#x6876;&#x5185;&#x7684;&#x5143;&#x7D20;&#x901A;&#x5E38;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#xFF0C;&#x6216;&#x8005;&#x4E0D;&#x591A;&#x4E8E;&#x67D0;&#x4E2A;&#x7279;&#x5B9A;&#x6BD4;&#x7387;</span></div><div class="line">        <span class="comment">// &#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x5C06;&#x8FD9;&#x4E2A;&#x64CD;&#x4F5C;&#x770B;&#x4F5C; O(1)</span></div><div class="line">        <span class="keyword">while</span>(de) {</div><div class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> h;</div><div class="line"></div><div class="line">            nextde = de-&gt;next;</div><div class="line"></div><div class="line">            <span class="comment">/* Get the index in the new hash table */</span></div><div class="line">            <span class="comment">// &#x8BA1;&#x7B97;&#x5143;&#x7D20;&#x5728; ht[1] &#x7684;&#x54C8;&#x5E0C;&#x503C;</span></div><div class="line">            h = dictHashKey(d, de-&gt;key) &amp; d-&gt;ht[<span class="number">1</span>].sizemask;</div><div class="line"></div><div class="line">            <span class="comment">// &#x6DFB;&#x52A0;&#x8282;&#x70B9;&#x5230; ht[1] &#xFF0C;&#x8C03;&#x6574;&#x6307;&#x9488;</span></div><div class="line">            de-&gt;next = d-&gt;ht[<span class="number">1</span>].table[h];</div><div class="line">            d-&gt;ht[<span class="number">1</span>].table[h] = de;</div><div class="line"></div><div class="line">            <span class="comment">// &#x66F4;&#x65B0;&#x8BA1;&#x6570;&#x5668;</span></div><div class="line">            d-&gt;ht[<span class="number">0</span>].used--;</div><div class="line">            d-&gt;ht[<span class="number">1</span>].used++;</div><div class="line"></div><div class="line">            de = nextde;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// &#x8BBE;&#x7F6E;&#x6307;&#x9488;&#x4E3A; NULL &#xFF0C;&#x65B9;&#x4FBF;&#x4E0B;&#x6B21; rehash &#x65F6;&#x8DF3;&#x8FC7;</span></div><div class="line">        d-&gt;ht[<span class="number">0</span>].table[d-&gt;rehashidx] = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">        <span class="comment">// &#x524D;&#x8FDB;&#x81F3;&#x4E0B;&#x4E00;&#x7D22;&#x5F15;</span></div><div class="line">        d-&gt;rehashidx++;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// &#x901A;&#x77E5;&#x8C03;&#x7528;&#x8005;&#xFF0C;&#x8FD8;&#x6709;&#x5143;&#x7D20;&#x7B49;&#x5F85; rehash</span></div><div class="line">    <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x4ECE;&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x5728;rehash&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF1A;</p>
<ol>
<li>&#x6BCF;&#x6B21;&#x8FC1;&#x79FB;&#x4E00;&#x4E2A;key&#x5BF9;&#x5E94;&#x7684;&#x94FE;</li>
<li>&#x8FC1;&#x79FB;&#x5B8C;&#x6210;&#x4E4B;&#x540E;&#x539F;&#x6765;&#x7684;key&#x5BF9;&#x5E94;&#x7684;&#x94FE;&#x8BBE;&#x4E3A;null</li>
<li>&#x65B0;&#x7684;&#x94FE;&#x91C7;&#x7528;&#x5934;&#x63D2;&#x6CD5;&#x63D2;&#x5165;&#x5143;&#x7D20;,&#x66F4;&#x65B0;&#x5BF9;&#x5E94;&#x7684;&#x5143;&#x7D20;&#x8BA1;&#x6570;</li>
</ol>
<h3 id="dictSetVal"><a href="#dictSetVal" class="headerlink" title="dictSetVal"></a>dictSetVal</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> dictSetVal(d, entry, _val_) do { \</span></div><div class="line">    <span class="meta-keyword">if</span> ((d)-&gt;type-&gt;valDup) \</div><div class="line">        entry-&gt;v.val = (d)-&gt;type-&gt;valDup((d)-&gt;privdata, _val_); \</div><div class="line">    <span class="meta-keyword">else</span> \</div><div class="line">        entry-&gt;v.val = (_val_); \</div><div class="line">} while(0)</div></pre></td></tr></table></figure>
<h2 id="dictReplace"><a href="#dictReplace" class="headerlink" title="dictReplace"></a>dictReplace</h2><p>&#x5C31;&#x662F;&#x7528;&#x65B0;&#x7684;&#x503C;&#x4EE3;&#x66FF;&#x65E7;&#x7684;&#x503C;<br>&#x5982;&#x679C;key&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x6DFB;&#x52A0;<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictReplace</span><span class="params">(dict *d, <span class="keyword">void</span> *key, <span class="keyword">void</span> *val)</span></span></div><div class="line">{</div><div class="line">    dictEntry *entry, auxentry;</div><div class="line"></div><div class="line">    <span class="comment">/* Try to add the element. If the key</span></div><div class="line">     * does not exists dictAdd will suceed. */</div><div class="line">    <span class="comment">// &#x5C1D;&#x8BD5;&#x6DFB;&#x52A0;&#x65B0;&#x5143;&#x7D20;&#x5230;&#x54C8;&#x5E0C;&#x8868;</span></div><div class="line">    <span class="comment">// &#x53EA;&#x8981; key &#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x6DFB;&#x52A0;&#x5C31;&#x4F1A;&#x6210;&#x529F;&#x3002;</span></div><div class="line">    <span class="comment">// O(1)</span></div><div class="line">    <span class="keyword">if</span> (dictAdd(d, key, val) == DICT_OK)</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">// &#x5982;&#x679C;&#x6DFB;&#x52A0;&#x5931;&#x8D25;&#xFF0C;&#x90A3;&#x4E48;&#x8BF4;&#x660E;&#x5143;&#x7D20;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;</span></div><div class="line">    <span class="comment">// &#x83B7;&#x53D6;&#x8FD9;&#x4E2A;&#x5143;&#x7D20;&#x6240;&#x5BF9;&#x5E94;&#x7684;&#x8282;&#x70B9;</span></div><div class="line">    <span class="comment">// O(1)</span></div><div class="line">    entry = dictFind(d, key);</div><div class="line"></div><div class="line">    <span class="comment">/* Set the new value and free the old one. Note that it is important</span></div><div class="line">     * to do that in this order, as the value may just be exactly the same</div><div class="line">     * as the previous one. In this context, think to reference counting,</div><div class="line">     * you want to increment (set), and then decrement (free), and not the</div><div class="line">     * reverse. */</div><div class="line"><span class="comment">///@alex:&#x6CE8;&#x610F;&#x8FD9;&#x4E2A;&#x987A;&#x5E8F;&#xFF0C;</span></div><div class="line"><span class="comment">///&#x5982;&#x679C;&#x7528;&#x7684;&#x662F;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#xFF0C;&#x4E14;&#x65E7;&#x503C;&#x7684;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x4E3A;1</span></div><div class="line"><span class="comment">///&#x5982;&#x679C;&#x662F;&#x5148;&#x91CA;&#x653E;&#x518D;&#x8BBE;&#x7F6E;&#x503C;&#xFF0C;&#x4F1A;&#x5BFC;&#x81F4;&#x4E0D;&#x5FC5;&#x8981;&#x7684;&#x91CA;&#x653E;&#x548C;&#x65B0;&#x5EFA;</span></div><div class="line"><span class="comment">///&#x800C;&#x4FDD;&#x5B58;&#x65E7;&#x503C;&#xFF0C;&#x5148;&#x8BBE;&#x7F6E;&#x518D;&#x91CA;&#x653E;&#xFF0C;&#x4F1A;&#x907F;&#x514D;&#x4E0A;&#x8FF0;&#x95EE;&#x9898;,&#x6548;&#x7387;&#x66F4;&#x9AD8;</span></div><div class="line">    auxentry = *entry;          <span class="comment">// &#x6307;&#x5411;&#x65E7;&#x503C;</span></div><div class="line">    dictSetVal(d, entry, val);  <span class="comment">// &#x8BBE;&#x7F6E;&#x65B0;&#x503C;</span></div><div class="line">    dictFreeVal(d, &amp;auxentry);  <span class="comment">// &#x91CA;&#x653E;&#x65E7;&#x503C;</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div></pre></td></tr></table></figure></p>
<h2 id="dictDelete"><a href="#dictDelete" class="headerlink" title="dictDelete"></a>dictDelete</h2><p>&#x5220;&#x9664;hash&#x8868;&#x4E2D;&#x7684;key&#xFF0C;&#x5E76;&#x4E14;&#x91CA;&#x653E;&#x4FDD;&#x5B58;key&#x7684;&#x8FD9;&#x4E2A;&#x8282;&#x70B9;<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictDelete</span><span class="params">(dict *ht, <span class="keyword">const</span> <span class="keyword">void</span> *key)</span> </span>{</div><div class="line"><span class="comment">///@alex: nofree = 0, &#x8868;&#x793A;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x91CA;&#x653E;</span></div><div class="line">    <span class="keyword">return</span> dictGenericDelete(ht,key,<span class="number">0</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dictGenericDelete</span><span class="params">(dict *d, <span class="keyword">const</span> <span class="keyword">void</span> *key, <span class="keyword">int</span> nofree)</span></span></div><div class="line">{</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> h, idx;</div><div class="line">    dictEntry *he, *prevHe;</div><div class="line">    <span class="keyword">int</span> table;</div><div class="line"></div><div class="line">    <span class="comment">// &#x7A7A;&#x8868;&#xFF1F;</span></div><div class="line">    <span class="keyword">if</span> (d-&gt;ht[<span class="number">0</span>].size == <span class="number">0</span>) <span class="keyword">return</span> DICT_ERR; <span class="comment">/* d-&gt;ht[0].table is NULL */</span></div><div class="line"></div><div class="line">    <span class="comment">// &#x6E10;&#x8FDB;&#x5F0F; rehash</span></div><div class="line">    <span class="keyword">if</span> (dictIsRehashing(d)) _dictRehashStep(d);</div><div class="line"></div><div class="line">    <span class="comment">// &#x8BA1;&#x7B97;&#x54C8;&#x5E0C;&#x503C;</span></div><div class="line">    h = dictHashKey(d, key);</div><div class="line"></div><div class="line">    <span class="comment">// &#x5728;&#x4E24;&#x4E2A;&#x54C8;&#x5E0C;&#x8868;&#x4E2D;&#x67E5;&#x627E;</span></div><div class="line">    <span class="keyword">for</span> (table = <span class="number">0</span>; table &lt;= <span class="number">1</span>; table++) {</div><div class="line">        <span class="comment">// &#x7D22;&#x5F15;&#x503C;</span></div><div class="line">        idx = h &amp; d-&gt;ht[table].sizemask;</div><div class="line">        <span class="comment">// &#x7D22;&#x5F15;&#x5728;&#x6570;&#x7EC4;&#x4E2D;&#x5BF9;&#x5E94;&#x7684;&#x8868;&#x5934;</span></div><div class="line">        he = d-&gt;ht[table].table[idx];</div><div class="line">        prevHe = <span class="literal">NULL</span>;</div><div class="line">        <span class="comment">// &#x904D;&#x5386;&#x94FE;&#x8868;</span></div><div class="line">        <span class="comment">// &#x56E0;&#x4E3A;&#x94FE;&#x8868;&#x7684;&#x5143;&#x7D20;&#x6570;&#x91CF;&#x901A;&#x5E38;&#x4E3A; 1 &#xFF0C;&#x6216;&#x8005;&#x7EF4;&#x6301;&#x5728;&#x4E00;&#x4E2A;&#x5F88;&#x5C0F;&#x7684;&#x6BD4;&#x7387;</span></div><div class="line">        <span class="comment">// &#x56E0;&#x6B64;&#x53EF;&#x4EE5;&#x5C06;&#x8FD9;&#x4E2A;&#x64CD;&#x4F5C;&#x770B;&#x4F5C; O(1)</span></div><div class="line">        <span class="keyword">while</span>(he) {</div><div class="line">            <span class="comment">// &#x5BF9;&#x6BD4;</span></div><div class="line">            <span class="keyword">if</span> (dictCompareKeys(d, key, he-&gt;key)) {</div><div class="line">                <span class="comment">/* Unlink the element from the list */</span></div><div class="line">                <span class="keyword">if</span> (prevHe)</div><div class="line">                    prevHe-&gt;next = he-&gt;next;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    d-&gt;ht[table].table[idx] = he-&gt;next;</div><div class="line">                <span class="comment">// &#x91CA;&#x653E;&#x8282;&#x70B9;&#x7684;&#x952E;&#x548C;&#x503C;</span></div><div class="line">                <span class="keyword">if</span> (!nofree) {</div><div class="line">                    dictFreeKey(d, he);</div><div class="line">                    dictFreeVal(d, he);</div><div class="line">                }</div><div class="line">                <span class="comment">// &#x91CA;&#x653E;&#x8282;&#x70B9;</span></div><div class="line">                zfree(he);</div><div class="line"></div><div class="line">                d-&gt;ht[table].used--;</div><div class="line"></div><div class="line">                <span class="keyword">return</span> DICT_OK;</div><div class="line">            }</div><div class="line">            prevHe = he;</div><div class="line">            he = he-&gt;next;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// &#x5982;&#x679C;&#x4E0D;&#x662F;&#x6B63;&#x5728;&#x8FDB;&#x884C; rehash &#xFF0C;</span></div><div class="line">        <span class="comment">// &#x90A3;&#x4E48;&#x65E0;&#x987B;&#x904D;&#x5386; ht[1]</span></div><div class="line">        <span class="keyword">if</span> (!dictIsRehashing(d)) <span class="keyword">break</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">return</span> DICT_ERR; <span class="comment">/* not found */</span></div><div class="line">}</div></pre></td></tr></table></figure></p>
<h2 id="dictResize"><a href="#dictResize" class="headerlink" title="dictResize"></a>dictResize</h2><p>&#x5BF9;dict&#x8FDB;&#x884C;&#x8C03;&#x6574;&#xFF0C;&#x8BA9;&#x8282;&#x70B9;&#x6570;/&#x6876;&#x6570;&#x63A5;&#x8FD1;1<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictResize</span><span class="params">(dict *d)</span></span></div><div class="line">{</div><div class="line">    <span class="keyword">int</span> minimal;</div><div class="line"></div><div class="line">    <span class="comment">// &#x4E0D;&#x80FD;&#x5728; dict_can_resize &#x4E3A;&#x5047;</span></div><div class="line"><span class="comment">///@alex: dict_can_resize&#x9ED8;&#x8BA4;&#x4E3A;1</span></div><div class="line">    <span class="comment">// &#x6216;&#x8005;&#x5B57;&#x5178;&#x6B63;&#x5728; rehash &#x65F6;&#x8C03;&#x7528;</span></div><div class="line">    <span class="keyword">if</span> (!dict_can_resize || dictIsRehashing(d)) <span class="keyword">return</span> DICT_ERR;</div><div class="line"></div><div class="line">    minimal = d-&gt;ht[<span class="number">0</span>].used;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (minimal &lt; DICT_HT_INITIAL_SIZE)</div><div class="line">        minimal = DICT_HT_INITIAL_SIZE;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> dictExpand(d, minimal);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* Expand or create the hash table */</span></div><div class="line"><span class="comment">/*</span></div><div class="line"> * &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x54C8;&#x5E0C;&#x8868;&#xFF0C;&#x5E76;&#x89C6;&#x60C5;&#x51B5;&#xFF0C;&#x8FDB;&#x884C;&#x4EE5;&#x4E0B;&#x52A8;&#x4F5C;&#x4E4B;&#x4E00;&#xFF1A;</div><div class="line"> *</div><div class="line"> *   1) &#x5982;&#x679C;&#x5B57;&#x5178;&#x91CC;&#x7684; ht[0] &#x4E3A;&#x7A7A;&#xFF0C;&#x5C06;&#x65B0;&#x54C8;&#x5E0C;&#x8868;&#x8D4B;&#x503C;&#x7ED9;&#x5B83;</div><div class="line"> *   2) &#x5982;&#x679C;&#x5B57;&#x5178;&#x91CC;&#x7684; ht[0] &#x4E0D;&#x4E3A;&#x7A7A;&#xFF0C;&#x90A3;&#x4E48;&#x5C06;&#x65B0;&#x54C8;&#x5E0C;&#x8868;&#x8D4B;&#x503C;&#x7ED9; ht[1] &#xFF0C;&#x5E76;&#x6253;&#x5F00; rehash &#x6807;&#x8BC6;</div><div class="line"> *</div><div class="line"> * T = O(N)</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">dictExpand</span><span class="params">(dict *d, <span class="keyword">unsigned</span> <span class="keyword">long</span> size)</span></span></div><div class="line">{</div><div class="line">    dictht n; <span class="comment">/* the new hash table */</span></div><div class="line"></div><div class="line">    <span class="comment">// &#x8BA1;&#x7B97;&#x54C8;&#x5E0C;&#x8868;&#x7684;&#x771F;&#x5B9E;&#x5927;&#x5C0F;</span></div><div class="line">    <span class="comment">// O(N)</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> realsize = _dictNextPower(size);</div><div class="line"></div><div class="line">    <span class="comment">/* the size is invalid if it is smaller than the number of</span></div><div class="line">     * elements already inside the hash table */</div><div class="line">    <span class="keyword">if</span> (dictIsRehashing(d) || d-&gt;ht[<span class="number">0</span>].used &gt; size)</div><div class="line">        <span class="keyword">return</span> DICT_ERR;</div><div class="line"></div><div class="line">    <span class="comment">/* Allocate the new hash table and initialize all pointers to NULL */</span></div><div class="line">    <span class="comment">// &#x521B;&#x5EFA;&#x5E76;&#x521D;&#x59CB;&#x5316;&#x65B0;&#x54C8;&#x5E0C;&#x8868;</span></div><div class="line">    <span class="comment">// O(N)</span></div><div class="line">    n.size = realsize;</div><div class="line">    n.sizemask = realsize<span class="number">-1</span>;</div><div class="line">    n.table = zcalloc(realsize*<span class="keyword">sizeof</span>(dictEntry*));</div><div class="line">    n.used = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* Is this the first initialization? If so it&apos;s not really a rehashing</span></div><div class="line">     * we just set the first hash table so that it can accept keys. */</div><div class="line">    <span class="comment">// &#x5982;&#x679C; ht[0] &#x4E3A;&#x7A7A;&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x5C31;&#x662F;&#x4E00;&#x6B21;&#x521B;&#x5EFA;&#x65B0;&#x54C8;&#x5E0C;&#x8868;&#x884C;&#x4E3A;</span></div><div class="line">    <span class="comment">// &#x5C06;&#x65B0;&#x54C8;&#x5E0C;&#x8868;&#x8BBE;&#x7F6E;&#x4E3A; ht[0] &#xFF0C;&#x7136;&#x540E;&#x8FD4;&#x56DE;</span></div><div class="line">    <span class="keyword">if</span> (d-&gt;ht[<span class="number">0</span>].table == <span class="literal">NULL</span>) {</div><div class="line">        d-&gt;ht[<span class="number">0</span>] = n;</div><div class="line">        <span class="keyword">return</span> DICT_OK;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Prepare a second hash table for incremental rehashing */</span></div><div class="line">    <span class="comment">// &#x5982;&#x679C; ht[0] &#x4E0D;&#x4E3A;&#x7A7A;&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x5C31;&#x662F;&#x4E00;&#x6B21;&#x6269;&#x5C55;&#x5B57;&#x5178;&#x7684;&#x884C;&#x4E3A;</span></div><div class="line">    <span class="comment">// &#x5C06;&#x65B0;&#x54C8;&#x5E0C;&#x8868;&#x8BBE;&#x7F6E;&#x4E3A; ht[1] &#xFF0C;&#x5E76;&#x6253;&#x5F00; rehash &#x6807;&#x8BC6;</span></div><div class="line">    d-&gt;ht[<span class="number">1</span>] = n;</div><div class="line">    d-&gt;rehashidx = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> DICT_OK;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * &#x8BA1;&#x7B97;&#x54C8;&#x5E0C;&#x8868;&#x7684;&#x771F;&#x5B9E;&#x4F53;&#x79EF;</div><div class="line"> *</div><div class="line"> * &#x5982;&#x679C; size &#x5C0F;&#x4E8E;&#x7B49;&#x4E8E; DICT_HT_INITIAL_SIZE &#xFF0C;</div><div class="line"> * &#x90A3;&#x4E48;&#x8FD4;&#x56DE; DICT_HT_INITIAL_SIZE &#xFF0C;</div><div class="line"> * &#x5426;&#x5219;&#x8FD9;&#x4E2A;&#x503C;&#x4E3A;&#x7B2C;&#x4E00;&#x4E2A; &gt;= size &#x7684;&#x4E8C;&#x6B21;&#x5E42;&#x3002;</div><div class="line"> *</div><div class="line"> * T = O(N)</div><div class="line"> */</div><div class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> _dictNextPower(<span class="keyword">unsigned</span> <span class="keyword">long</span> size)</div><div class="line">{</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> i = DICT_HT_INITIAL_SIZE;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (size &gt;= LONG_MAX) <span class="keyword">return</span> LONG_MAX;</div><div class="line">    <span class="keyword">while</span>(<span class="number">1</span>) {</div><div class="line">        <span class="keyword">if</span> (i &gt;= size)</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        i *= <span class="number">2</span>;</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x662F;&#x5426;&#x9700;&#x8981;&#x8FDB;&#x884C;resize&#x65F6;&#x901A;&#x8FC7;htNeedsResize&#x51FD;&#x6570;&#x6765;&#x5224;&#x65AD;&#x7684;<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">htNeedsResize</span><span class="params">(dict *dict)</span> </span>{</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> size, used;</div><div class="line"></div><div class="line">    <span class="comment">// &#x54C8;&#x5E0C;&#x8868;&#x5927;&#x5C0F;</span></div><div class="line">    size = dictSlots(dict);</div><div class="line"></div><div class="line">    <span class="comment">// &#x54C8;&#x5E0C;&#x8868;&#x5DF2;&#x7528;&#x8282;&#x70B9;&#x6570;&#x91CF;</span></div><div class="line">    used = dictSize(dict);</div><div class="line"></div><div class="line">    <span class="comment">// &#x5F53;&#x54C8;&#x5E0C;&#x8868;&#x7684;&#x5927;&#x5C0F;&#x5927;&#x4E8E; DICT_HT_INITIAL_SIZE</span></div><div class="line">    <span class="comment">// &#x5E76;&#x4E14;&#x5B57;&#x5178;&#x7684;&#x586B;&#x5145;&#x7387;&#x4F4E;&#x4E8E; REDIS_HT_MINFILL &#x65F6;</span></div><div class="line">    <span class="comment">// &#x8FD4;&#x56DE; 1</span></div><div class="line">    <span class="keyword">return</span> (size &amp;&amp; used &amp;&amp; size &gt; DICT_HT_INITIAL_SIZE &amp;&amp;</div><div class="line">            (used*<span class="number">100</span>/size &lt; REDIS_HT_MINFILL));</div><div class="line">}</div></pre></td></tr></table></figure></p>
<p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x5728;dict&#x7684;&#x5927;&#x5C0F;&#x5927;&#x4E8E;&#x6700;&#x5C0F;&#x521D;&#x59CB;&#x503C;&#x4E14;&#x4F7F;&#x7528;&#x7387;&lt;10%&#x7684;&#x65F6;&#x5019;&#x56DE;&#x8FDB;&#x884C;resize</p>
<h2 id="dictIterator"><a href="#dictIterator" class="headerlink" title="dictIterator"></a>dictIterator</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dictIterator {</div><div class="line">    <span class="comment">// &#x6B63;&#x5728;&#x8FED;&#x4EE3;&#x7684;&#x5B57;&#x5178;</span></div><div class="line">    dict *d;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> table,              <span class="comment">// &#x6B63;&#x5728;&#x8FED;&#x4EE3;&#x7684;&#x54C8;&#x5E0C;&#x8868;&#x7684;&#x53F7;&#x7801;&#xFF08;0 &#x6216;&#x8005; 1&#xFF09;</span></div><div class="line">        index,              <span class="comment">// &#x6B63;&#x5728;&#x8FED;&#x4EE3;&#x7684;&#x54C8;&#x5E0C;&#x8868;&#x6570;&#x7EC4;&#x7684;&#x7D22;&#x5F15;</span></div><div class="line">        safe;               <span class="comment">// &#x662F;&#x5426;&#x5B89;&#x5168;&#xFF1F;</span></div><div class="line"></div><div class="line">    dictEntry *entry,       <span class="comment">// &#x5F53;&#x524D;&#x54C8;&#x5E0C;&#x8282;&#x70B9;</span></div><div class="line">              *nextEntry;   <span class="comment">// &#x5F53;&#x524D;&#x54C8;&#x5E0C;&#x8282;&#x70B9;&#x7684;&#x540E;&#x7EE7;&#x8282;&#x70B9;</span></div><div class="line">} dictIterator;</div></pre></td></tr></table></figure>
<h3 id="&#x521B;&#x5EFA;dictIterator"><a href="#&#x521B;&#x5EFA;dictIterator" class="headerlink" title="&#x521B;&#x5EFA;dictIterator"></a>&#x521B;&#x5EFA;dictIterator</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function">dictIterator *<span class="title">dictGetIterator</span><span class="params">(dict *d)</span></span></div><div class="line">{</div><div class="line">    dictIterator *iter = zmalloc(<span class="keyword">sizeof</span>(*iter));</div><div class="line"></div><div class="line">    iter-&gt;d = d;</div><div class="line">    iter-&gt;table = <span class="number">0</span>;</div><div class="line">    iter-&gt;index = <span class="number">-1</span>;</div><div class="line">    iter-&gt;safe = <span class="number">0</span>;</div><div class="line">    iter-&gt;entry = <span class="literal">NULL</span>;</div><div class="line">    iter-&gt;nextEntry = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> iter;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function">dictIterator *<span class="title">dictGetSafeIterator</span><span class="params">(dict *d)</span> </span>{</div><div class="line">    dictIterator *i = dictGetIterator(d);</div><div class="line"></div><div class="line">    i-&gt;safe = <span class="number">1</span>;</div><div class="line">    <span class="keyword">return</span> i;</div><div class="line">}</div></pre></td></tr></table></figure>
<h2 id="&#x83B7;&#x53D6;&#x4E0B;&#x4E00;&#x4E2A;dictEntry"><a href="#&#x83B7;&#x53D6;&#x4E0B;&#x4E00;&#x4E2A;dictEntry" class="headerlink" title="&#x83B7;&#x53D6;&#x4E0B;&#x4E00;&#x4E2A;dictEntry"></a>&#x83B7;&#x53D6;&#x4E0B;&#x4E00;&#x4E2A;dictEntry</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function">dictEntry *<span class="title">dictNext</span><span class="params">(dictIterator *iter)</span></span></div><div class="line">{</div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) {</div><div class="line">        <span class="keyword">if</span> (iter-&gt;entry == <span class="literal">NULL</span>) {</div><div class="line"></div><div class="line">            dictht *ht = &amp;iter-&gt;d-&gt;ht[iter-&gt;table];</div><div class="line"></div><div class="line">            <span class="comment">// &#x5728;&#x5F00;&#x59CB;&#x8FED;&#x4EE3;&#x4E4B;&#x524D;&#xFF0C;&#x589E;&#x52A0;&#x5B57;&#x5178; iterators &#x8BA1;&#x6570;&#x5668;&#x7684;&#x503C;</span></div><div class="line">            <span class="comment">// &#x53EA;&#x6709;&#x5B89;&#x5168;&#x8FED;&#x4EE3;&#x5668;&#x624D;&#x4F1A;&#x589E;&#x52A0;&#x8BA1;&#x6570;</span></div><div class="line">            <span class="keyword">if</span> (iter-&gt;safe &amp;&amp;</div><div class="line">                iter-&gt;index == <span class="number">-1</span> &amp;&amp;</div><div class="line">                iter-&gt;table == <span class="number">0</span>)</div><div class="line">                iter-&gt;d-&gt;iterators++;</div><div class="line"></div><div class="line">            <span class="comment">// &#x589E;&#x52A0;&#x7D22;&#x5F15;</span></div><div class="line">            iter-&gt;index++;</div><div class="line"></div><div class="line">            <span class="comment">// &#x5F53;&#x8FED;&#x4EE3;&#x7684;&#x5143;&#x7D20;&#x6570;&#x91CF;&#x8D85;&#x8FC7; ht-&gt;size &#x7684;&#x503C;</span></div><div class="line">            <span class="comment">// &#x8BF4;&#x660E;&#x8FD9;&#x4E2A;&#x8868;&#x5DF2;&#x7ECF;&#x8FED;&#x4EE3;&#x5B8C;&#x6BD5;&#x4E86;</span></div><div class="line">            <span class="keyword">if</span> (iter-&gt;index &gt;= (<span class="keyword">signed</span>) ht-&gt;size) {</div><div class="line">                <span class="comment">// &#x662F;&#x5426;&#x63A5;&#x7740;&#x8FED;&#x4EE3; ht[1] ?</span></div><div class="line">                <span class="keyword">if</span> (dictIsRehashing(iter-&gt;d) &amp;&amp; iter-&gt;table == <span class="number">0</span>) {</div><div class="line">                    iter-&gt;table++;</div><div class="line">                    iter-&gt;index = <span class="number">0</span>;</div><div class="line">                    ht = &amp;iter-&gt;d-&gt;ht[<span class="number">1</span>];</div><div class="line">                } <span class="keyword">else</span> {</div><div class="line">                <span class="comment">// &#x5982;&#x679C;&#x6CA1;&#x6709; ht[1] &#xFF0C;&#x6216;&#x8005;&#x5DF2;&#x7ECF;&#x8FED;&#x4EE3;&#x5B8C;&#x4E86; ht[1] &#x5230;&#x8FBE;&#x8FD9;&#x91CC;</span></div><div class="line">                <span class="comment">// &#x8DF3;&#x51FA;</span></div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="comment">// &#x6307;&#x5411;&#x4E0B;&#x4E00;&#x7D22;&#x5F15;&#x7684;&#x8282;&#x70B9;&#x94FE;&#x8868;</span></div><div class="line">            iter-&gt;entry = ht-&gt;table[iter-&gt;index];</div><div class="line"></div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            <span class="comment">// &#x6307;&#x5411;&#x94FE;&#x8868;&#x7684;&#x4E0B;&#x4E00;&#x8282;&#x70B9;</span></div><div class="line">            iter-&gt;entry = iter-&gt;nextEntry;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">// &#x4FDD;&#x5B58;&#x540E;&#x7EE7;&#x6307;&#x9488; nextEntry&#xFF0C;</span></div><div class="line">        <span class="comment">// &#x4EE5;&#x5E94;&#x5BF9;&#x5F53;&#x524D;&#x8282;&#x70B9; entry &#x53EF;&#x80FD;&#x88AB;&#x4FEE;&#x6539;&#x7684;&#x60C5;&#x51B5;</span></div><div class="line">        <span class="keyword">if</span> (iter-&gt;entry) {</div><div class="line">            <span class="comment">/* We need to save the &apos;next&apos; here, the iterator user</span></div><div class="line">             * may delete the entry we are returning. */</div><div class="line">            iter-&gt;nextEntry = iter-&gt;entry-&gt;next;</div><div class="line">            <span class="keyword">return</span> iter-&gt;entry;</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
<h3 id="&#x91CA;&#x653E;&#x8FED;&#x4EE3;&#x5668;"><a href="#&#x91CA;&#x653E;&#x8FED;&#x4EE3;&#x5668;" class="headerlink" title="&#x91CA;&#x653E;&#x8FED;&#x4EE3;&#x5668;"></a>&#x91CA;&#x653E;&#x8FED;&#x4EE3;&#x5668;</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dictReleaseIterator</span><span class="params">(dictIterator *iter)</span></span></div><div class="line">{</div><div class="line">    <span class="keyword">if</span> (iter-&gt;safe &amp;&amp; !(iter-&gt;index == <span class="number">-1</span> &amp;&amp; iter-&gt;table == <span class="number">0</span>))</div><div class="line">        iter-&gt;d-&gt;iterators--;</div><div class="line"></div><div class="line">    zfree(iter);</div><div class="line">}</div></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/redis/" rel="tag">#redis</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/06/19/redis-4-文件事件分析/" rel="next" title="redis-4-文件事件分析">
                <i class="fa fa-chevron-left"></i> redis-4-文件事件分析
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/06/19/二叉树的遍历/" rel="prev" title="二叉树的遍历">
                二叉树的遍历 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="alexkkk" />
          <p class="site-author-name" itemprop="name">alexkkk</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">17</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-整体结构图"><span class="nav-number">1.</span> <span class="nav-text">1.整体结构图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dict"><span class="nav-number">2.</span> <span class="nav-text">dict</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dictType"><span class="nav-number">3.</span> <span class="nav-text">dictType</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#setDictType"><span class="nav-number">3.1.</span> <span class="nav-text">setDictType</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zsetDictType"><span class="nav-number">3.2.</span> <span class="nav-text">zsetDictType</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dbDictType"><span class="nav-number">3.3.</span> <span class="nav-text">dbDictType</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#shaScriptObjectDictType"><span class="nav-number">3.4.</span> <span class="nav-text">shaScriptObjectDictType</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#keyptrDictType"><span class="nav-number">3.5.</span> <span class="nav-text">keyptrDictType</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#commandTableDictType"><span class="nav-number">3.6.</span> <span class="nav-text">commandTableDictType</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hashDictType"><span class="nav-number">3.7.</span> <span class="nav-text">hashDictType</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#keylistDictType"><span class="nav-number">3.8.</span> <span class="nav-text">keylistDictType</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#clusterNodesDictType"><span class="nav-number">3.9.</span> <span class="nav-text">clusterNodesDictType</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#migrateCacheDictType"><span class="nav-number">3.10.</span> <span class="nav-text">migrateCacheDictType</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-dictht"><span class="nav-number">4.</span> <span class="nav-text">2.dictht</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-创建dict"><span class="nav-number">5.</span> <span class="nav-text">3.创建dict</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-清空dict"><span class="nav-number">6.</span> <span class="nav-text">4.清空dict</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加key-value"><span class="nav-number">7.</span> <span class="nav-text">添加key/value</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dictSetVal"><span class="nav-number">7.1.</span> <span class="nav-text">dictSetVal</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dictReplace"><span class="nav-number">8.</span> <span class="nav-text">dictReplace</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dictDelete"><span class="nav-number">9.</span> <span class="nav-text">dictDelete</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dictResize"><span class="nav-number">10.</span> <span class="nav-text">dictResize</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dictIterator"><span class="nav-number">11.</span> <span class="nav-text">dictIterator</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建dictIterator"><span class="nav-number">11.1.</span> <span class="nav-text">创建dictIterator</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取下一个dictEntry"><span class="nav-number">12.</span> <span class="nav-text">获取下一个dictEntry</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#释放迭代器"><span class="nav-number">12.1.</span> <span class="nav-text">释放迭代器</span></a></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">alexkkk</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
